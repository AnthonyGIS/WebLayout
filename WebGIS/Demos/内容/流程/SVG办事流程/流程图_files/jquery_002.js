var jDialog=(function($,undefined){var browserInfo=(function(){var userAgent=navigator.userAgent.toLowerCase();return{version:(userAgent.match(/.+(?:rv|it|ra|ie)[\/: ]([\d.]+)/)||[])[1],safari:/webkit/.test(userAgent),opera:/opera/.test(userAgent),msie:/msie/.test(userAgent)&&!/opera/.test(userAgent),mozilla:/mozilla/.test(userAgent)&&!/(compatible|webkit)/.test(userAgent)};})();var isIE6=browserInfo.msie&&parseInt(browserInfo.version,10)==6;var eventName=['show','close','resize','hide','enterKey','escKey'];var dialogInstances=[];var defaultOptions={modal:true,title:null,content:null,width:300,height:null,minWidth:200,minHeight:60,maxWidth:null,maxHeight:null,padding:'10px',fixed:true,left:null,top:null,closeable:true,hideOnClose:false,draggable:true,contentType:null,zIndex:1024,resizable:false,autoShow:true,autoMiddle:true,autoClose:0,showShadow:true,showTitle:true,textAlign:'inherit',buttonAlign:'right',dialogClassName:null,maskClassName:null,wobbleEnable:false,closeOnBodyClick:false,buttons:[],events:{}};var DialogClass=function(s){dialogInstances.push(this);this.cfg=$.extend({},defaultOptions,s);this.dom={element:null,buttons:[]};this._init();};DialogClass.prototype={constructor:DialogClass,_tempVars:{},title:function(title){if((title||'').length){this.dom.element.find('.j-dialog-title>span.j-dialog-txt').html(title||"");return this;}else{return this.dom.element.find(".j-dialog-title>span.j-dialog-txt").html();}},content:function(html){if((html||'').length){this.dom.element.find(".j-dialog-body").html(html).css({'text-align':this.cfg.textAlign});return this;}else{return $(".j-dialog-body",this.dom.element).html();}},width:function(width){if(parseInt(width,10)>=0){this.dom.element.css("width",width);return this;}else{return parseInt(this.dom.element.css('width'),10);}},height:function(height){height=parseInt(height,20)||0;if(height){var shellHeight=0;var bodyPaddings=(this.cfg.padding||'').split(/\s+/);switch(bodyPaddings.length){case 4:case 3:shellHeight+=(parseInt(bodyPaddings[0],10)||0)
+(parseInt(bodyPaddings[2],10)||0);break;case 2:case 1:shellHeight+=2*(parseInt(bodyPaddings[0],10)||0);break;}
shellHeight+=35;if(this.cfg.minHeight){height=Math.max(height,this.cfg.minHeight);}
if(this.cfg.maxHeight){height=Math.min(height,this.cfg.maxHeight);}
height-=shellHeight;$(".j-dialog-body",this.dom.element).css("height",height);return this;}else{return parseInt(this.dom.element.css('height'),10);}},middle:function(){var doc=$(document);var win=$(window);var o=this.cfg.fixed&&!isIE6?[0,0]:[doc.scrollLeft(),doc.scrollTop()];var left=o[0]+(win.width()-this.dom.element.outerWidth())/2;var top=o[1]+(win.height()-this.dom.element.outerHeight())/2;top=(top>=0)?top:0;return this.position({left:left,top:top});},position:function(pos){if((!pos.left||isNaN(parseInt(pos.left,10)))&&(!pos.top||isNaN(parseInt(pos.top,10)))){return this.dom.element.offset();}else{if(!pos.left||isNaN(parseInt(pos.left,10))){this.dom.element.css({"top":pos.top});}else if(!pos.top||isNaN(parseInt(pos.top,10))){this.dom.element.css({"left":pos.left});}else{this.dom.element.css({"left":pos.left,"top":pos.top});}
this.triggerHandler('resize');return this;}},show:function(){this.dom.element.show.apply(this.dom.element,arguments);if(this.mask){this.mask.cfg.safety=this.dom.element;this.mask.show.apply(this.mask,arguments);}
if(this.cfg.autoClose){var self=this;setTimeout(function(){self.close();},parseInt(this.cfg.autoClose,10)||3000)}
this.triggerHandler('show');return this;},hide:function(){this.dom.element.hide();if(this.mask){this.mask.hide.apply(this.mask,arguments);}
return this;},close:function(){var self=this;if(!self.dom.element[0]){return this;}
self.triggerHandler('close');$(window).unbind("resize",this._tempVars.onResize);self.mask&&self.mask.remove();this._tempVars.dragObj&&this._tempVars.dragObj.remove();self.dom.element.remove();for(var i=0,len=dialogInstances.length;i<len;i++){if(dialogInstances[i]==self){dialogInstances.splice(i,1);break;}}
return this;},buttons:function(buttons){var self=this;if(buttons&&buttons.length>0){this.cfg.buttons=buttons;var htmlBtns=[];$.each(buttons,function(i,btn){var v,cls='j-dialog-btn';if(btn.type=='highlight'){cls+=' x-highlight';}
v=btn.text||'确定';htmlBtns.push('<input type="button" class="'+cls+'" value="'+v+'" />');});var btnContainer=$('<div class="j-dialog-buttons"></div>').appendTo(this.dom.element).html(htmlBtns.join(''));btnContainer.css('text-align',this.cfg.buttonAlign||'right');var selfBtns=this.dom.buttons=$('input[type=button]',btnContainer);$.each(buttons,function(i,btn){var thisBtn=$(selfBtns[i]);thisBtn.click(function(e){if(btn.handler&&typeof btn.handler=='function'){btn.handler.call(thisBtn[0],thisBtn,self);}});if(!isIE6){thisBtn.hover(function(e){var cls_h='x-hover';if(thisBtn.hasClass('x-highlight')){cls_h='x-hlhover';}
thisBtn.addClass(cls_h);},function(e){thisBtn.removeClass('x-hover').removeClass('x-hlhover');});}});return this;}else{return this.dom.buttons;}},bind:function(){this.dom.element.bind.apply(this.dom.element,arguments);return this;},triggerHandler:function(){this.dom.element.trigger.apply(this.dom.element,arguments);return this;},_init:function(){var self=this;if(!this.cfg.showTitle){this.cfg.draggable=false;}
if(!isNaN(parseInt(this.cfg.top))||!isNaN(parseInt(this.cfg.left))||this.cfg.anchor){this.cfg.autoMiddle=false;}
var className='j-dialog'+(this.cfg.dialogClassName?this.cfg.dialogClassName:'');if(!isIE6&&this.cfg.fixed){className+=' j-dialog-fix';}
if(this.cfg.showShadow){className+=' j-dialog-shadow';}
this._addMask();this.dom.element=$('<div class="'+className+'"></div>').css({"zIndex":this.cfg.zIndex,"display":"none"}).appendTo(document.body).focus();this._setupTitleBar().title(this.cfg.title);this._setupContent().content(this.cfg.content);this.buttons(this.cfg.buttons);this.width(this.cfg.width);this.height(this.cfg.height);$('#j-dialog-body',this.dom.element).css('padding',this.cfg.padding);$.each(eventName,function(i,evt){if(self.cfg.events[evt]){self.dom.element.bind(evt,{dialog:self},self.cfg.events[evt]);}});this._setupEscKey()._setupEnterKey()._setupBodyClick();this.cfg.autoShow&&this.show();if(this.cfg.anchor){this._tempVars.domAnchor=$(this.cfg.anchor.target);if(!this._tempVars.domAnchor[0]){throw new Error('The "anchor.target" must be a HTMLElement instance!');return this;}
this._setupTriangle();}else if(this.cfg.autoMiddle){this.middle();}else{this.position({left:this.cfg.left,top:this.cfg.top});}
this._tempVars.onResize=function(){$(window).unbind("resize",self._tempVars.onResize);if(self.cfg.autoMiddle){self.middle();}
self.triggerHandler('resize');self.sizeTimer=setTimeout(function(){$(window).bind("resize",self._tempVars.onResize);},10);}
$(window).bind("resize",this._tempVars.onResize);},_addMask:function(){var self=this;if(this.cfg.modal){var maskCfg={};if(this.cfg.maskClassName){maskCfg.className=this.cfg.maskClassName;}
this.mask=jMask.init(maskCfg);if(this.cfg.wobbleEnable){this._tempVars.cssAnimationGoing=false;this.mask.element.click(function(e){if(self._tempVars.cssAnimationGoing)return false;self.dom.element.addClass('j-ani-wobble');self._tempVars.cssAnimationGoing=true;setTimeout(function(){self.dom.element.removeClass('j-ani-wobble');self._tempVars.cssAnimationGoing=false;},1100);});}}
return self;},_setupBodyClick:function(){var self=this;if(!self.cfg.closeOnBodyClick){return this;}
var func=function(evt){if(!$.contains(self.dom.element[0],evt.target)){self.close();}};self.bind('show',function(evt){$(document).bind("mousedown",func);});$.each(['hide','close'],function(i,eventName){self.bind(eventName,function(evt){$(document).unbind('mousedown',func);});});return self;},_setupTitleBar:function(){var self=this;if(this.cfg.closeable){var btnClose=$('<a href="#" class="j-dialog-close" title="关闭">&nbsp;</a>').appendTo(this.dom.element).bind({click:function(evt){self.cfg.hideOnClose?self.hide():self.close();evt.preventDefault();evt.stopPropagation();},mousedown:function(evt){evt.preventDefault();evt.stopPropagation();}});if(!this.cfg.showTitle){btnClose.addClass('btn-without-title');}}
if(!this.cfg.showTitle){return self;}
this._tempVars.titleBar=$('<div class="j-dialog-title"><span class="j-dialog-txt"></span></div>').appendTo(this.dom.element);if(this.cfg.draggable){this._tempVars.titleBar.addClass('j-draggable');var offset=null;this._tempVars.dragObj=jDrag.init({handle:self._tempVars.titleBar,target:self.dom.element,onDown:function(){self._setupHackDiv(1);self.dom.element.addClass('j-user-select');},onUp:function(){self._setupHackDiv(0);self.dom.element.removeClass('j-user-select');}});}
return self;},_setupHackDiv:function(display){var self=this;if(display){if($("IFRAME",self.dom.element).length>0){var con=$(".j-dialog-content",self.dom.element);self.hack_div=(self.hack_div||$("<div></div>")).appendTo(con).css({position:"absolute","left":0,"top":0,"cursor":"move","display":"block","width":self.dom.element.outerWidth(),"height":self.dom.element.outerHeight()});}}else{if(self.hack_div){self.hack_div.css("display","none");}}
return self;},_setupEscKey:function(){var self=this;var func=function(event){if(event.keyCode==27){self.triggerHandler('escKey');}};$(self.dom.element).bind('show',function(evt){$(document).bind("keydown",func);});$.each(['hide','close'],function(i,eventName){$(self.dom.element).bind(eventName,function(evt){$(document).unbind('keydown',func);});});return self;},_setupEnterKey:function(){var self=this;var func=function(event){if(event.keyCode==13||event.keyCode==10){self.triggerHandler("enterKey");}};$(self.dom.element).bind('show',function(evt){$(document).bind("keydown",func);});$.each(['hide','close'],function(i,eventName){$(self.dom.element).bind(eventName,function(evt){$(document).unbind('keydown',func);});});return self;},_setupTriangle:function(){this._tempVars.triangle=$(['<div class="j-triangle">','<div class="t-border"></div>','<div class="t-inset"></div>','</div>'].join('')).appendTo(this.dom.element).addClass('anchor-'+{left:'right',right:'left',top:'bottom',bottom:'top'}[{'left':'left','left-top':'left','left-bottom':'left','top':'top','top-left':'top','top-right':'top','right':'right','right-top':'right','right-bottom':'right','bottom':'bottom','bottom-left':'bottom','bottom-right':'bottom'}[this.cfg.anchor.position||'right']]);var posTriangle={},posDialog={};var domAnchorOffset=this._tempVars.domAnchor.offset();var domAnchorSize={width:parseInt(this._tempVars.domAnchor.width(),10),height:parseInt(this._tempVars.domAnchor.height(),10)};var domDialogSize={width:parseInt(this.width(),10),height:parseInt(this.height(),10)};var offset=$.extend({top:0,left:0,right:0,bottom:0},this.cfg.anchor.offset||{});var tpfs=parseInt(this.cfg.anchor.trianglePosFromStart,10)||0;switch((this.cfg.anchor.position||'right').toLowerCase()){case 'top':posTriangle={top:0,left:tpfs?tpfs:(domDialogSize.width-24)/2,};posDialog={top:(domAnchorOffset.top-domDialogSize.height-12-offset.top),left:(domAnchorOffset.left+(domAnchorSize.width-domDialogSize.width)/2+offset.left)+50,};break;case 'top-left':posTriangle={top:0,left:tpfs?tpfs:(domDialogSize.width-24)/2};posDialog={top:(domAnchorOffset.top-domDialogSize.height-12-offset.top),left:(domAnchorOffset.left+offset.left)+100};break;case 'top-right':posTriangle={top:0,left:tpfs?domDialogSize.width-24-tpfs:(domDialogSize.width-24)/2};posDialog={top:(domAnchorOffset.top-domDialogSize.height-12-offset.top),left:(domAnchorOffset.left+domAnchorSize.width)-domDialogSize.width+offset.right};break;case 'right':posTriangle={top:tpfs?tpfs-domDialogSize.height:-(domDialogSize.height+24)/2,left:-24};posDialog={top:domAnchorOffset.top+(domAnchorSize.height-domDialogSize.height)/2+offset.top,left:domAnchorOffset.left+domAnchorSize.width+12+offset.right};break;case 'right-top':posTriangle={top:tpfs?tpfs-domDialogSize.height:-(domDialogSize.height+24)/2,left:-24};posDialog={top:(domAnchorOffset.top+offset.top),left:(domAnchorOffset.left+domAnchorSize.width+12+offset.right)+100};break;case 'right-bottom':posTriangle={top:tpfs?-24-tpfs:-(domDialogSize.height+24)/2,left:-24};posDialog={top:domAnchorOffset.top+domAnchorSize.height-domDialogSize.height-offset.bottom,left:domAnchorOffset.left+domAnchorSize.width+12+offset.right};break;case 'bottom':posTriangle={top:-(domDialogSize.height+24),left:tpfs?tpfs:(domDialogSize.width-24)/2};posDialog={top:(domAnchorOffset.top+domAnchorSize.height+12+offset.bottom)+40,left:(domAnchorOffset.left+(domAnchorSize.width-domDialogSize.width)/2+offset.left)+50};break;case 'bottom-left':posTriangle={top:-(domDialogSize.height+24),left:tpfs?tpfs:(domDialogSize.width-24)/2};posDialog={top:domAnchorOffset.top+domAnchorSize.height+12+offset.bottom,left:domAnchorOffset.left+offset.left};break;case 'bottom-right':posTriangle={top:-(domDialogSize.height+24),left:tpfs?domDialogSize.width-24-tpfs:(domDialogSize.width-24)/2};posDialog={top:domAnchorOffset.top+domAnchorSize.height+12+offset.bottom,left:(domAnchorOffset.left+domAnchorSize.width)-domDialogSize.width+offset.right};break;case 'left':posTriangle={top:tpfs?tpfs-domDialogSize.height:-(domDialogSize.height+24)/2,left:domDialogSize.width};posDialog={top:domAnchorOffset.top+(domAnchorSize.height-domDialogSize.height)/2+offset.top,left:domAnchorOffset.left-domDialogSize.width-12-offset.left};break;case 'left-top':posTriangle={top:tpfs?tpfs-domDialogSize.height:-(domDialogSize.height+24)/2,left:domDialogSize.width};posDialog={top:domAnchorOffset.top+offset.top,left:domAnchorOffset.left-domDialogSize.width-12-offset.left};break;case 'left-bottom':posTriangle={top:tpfs?-24-tpfs:-(domDialogSize.height+24)/2,left:domDialogSize.width};posDialog={top:domAnchorOffset.top+domAnchorSize.height-domDialogSize.height-offset.bottom,left:domAnchorOffset.left-domDialogSize.width-12-offset.left};break;}
this._tempVars.triangle.css(posTriangle);this.position(posDialog);this.dom.element.css('overflow','visible');return this;},_setupContent:function(){if(this.cfg.contentType==='iframe'){this.cfg.content=$("<iframe></iframe>").css({width:"100%",height:"100%",border:"none"}).attr({"src":this.cfg.content,"frameBorder":0});}
var wrap=$(['<div class="j-dialog-content">','<div class="j-dialog-body" id="j-dialog-body"></div>','</div>'].join(''));var self=this;this.dom.element.append(wrap);if(this.cfg.resizable){var con=$(".j-dialog-content",self.dom.element);this.cfg.minWidth=this.cfg.minWidth||0;this.cfg.minHeight=this.cfg.minHeight||0;$.each(['es'],function(k,v){var ele=$('<div class="resizable-'+v+'"><div></div></div>');self.dom.element.append(ele);var val_W=null,val_H=null;jDrag.init({handle:ele,onDown:function(event){self._setupHackDiv(1);val_W=parseInt(self.dom.element.width());val_H=parseInt(con.height());self.dom.element.addClass('j-user-select');},onMove:function(event,x,y){var width=val_W+x;var height=val_H+y;if(!((self.cfg.minWidth&&width<self.cfg.minWidth&&x<0)||(self.cfg.maxWidth&&(width>self.cfg.maxWidth)&&x>0)))
self.dom.element.width(width);if(!((self.cfg.minHeight&&(height<self.cfg.minHeight)&&y<0)||((self.cfg.maxHeight)&&(height>self.cfg.maxHeight)&&y>0)))
con.height(height);var w=self.dom.element.outerWidth(),h=self.dom.element.outerHeight();if(self.hack_div)
self.hack_div.css({"width":w,"height":h});},onUp:function(event){self._setupHackDiv(0);self.dom.element.removeClass('j-user-select');}});});}
return self;}};var _dialog=function(options){var cfg=$.extend({},options||{});return new DialogClass(cfg);};var _alert=function(content,button,options){options=options||{};button=$.extend({type:'highlight',handler:function(btn,dlg){dlg.close();}},button||{});options=$.extend({wobbleEnable:true},options,{content:content,buttons:[].concat(button),title:options.title?options.title:'提示'});return _dialog(options);};var _confirm=function(content,acceptButton,cancelButton,options){options=options||{};acceptButton=$.extend({type:'highlight',handler:function(btn,dlg){dlg.close();}},acceptButton||{});cancelButton=$.extend({text:'取消',handler:function(btn,dlg){dlg.close();}},cancelButton||{});options=$.extend({wobbleEnable:true},options,{content:content,buttons:[].concat([acceptButton,cancelButton]),title:options.title?options.title:'确认'});return _dialog(options);};var _message=function(content,options){options=options||{};options=$.extend({content:content,padding:'20px 10px 20px 10px',textAlign:'center'},options,{showTitle:false});return _dialog(options);};var _tip=function(content,anchor,options){options=options||{};options=$.extend({padding:'20px 10px 20px 10px',textAlign:'center',width:'auto',anchor:{target:null,position:'right'}},options,{content:content,anchor:anchor,showTitle:false,showShadow:false,modal:false,fixed:false});return _dialog(options);};var _iframe=function(url,options){options=options||{};options=$.extend({content:url,title:'窗口',width:600,height:300},options,{contentType:'iframe'});return _dialog(options);};return{version:'1.3',dialog:_dialog,alert:_alert,confirm:_confirm,message:_message,tip:_tip,iframe:_iframe};})(jQuery);